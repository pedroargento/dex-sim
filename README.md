# High-Frequency CCP Simulation Suite

This project implements a high-frequency Central Counterparty (CCP) simulation suite designed to compare an Adaptive ES (Expected Shortfall) CCP Model against a Fixed-Leverage Decentralized Exchange (FXD) Model. The simulation uses a GARCH-informed Monte Carlo approach to analyze risk metrics under various market conditions.

## Project Files

*   **`calibrate.py`**: A Python script for data preprocessing and GARCH(1,1) model calibration. It takes historical price data, calculates log returns and the Amihud Illiquidity Proxy, calibrates the GARCH model, and saves the parameters to `garch_params.json`.
*   **`simulation_engine.py`**: Contains the core logic for the simulation, defining the following classes:
    *   `MCReturnsGenerator`: Generates Monte Carlo price paths and correlated liquidity shocks using GARCH(1,1) volatility and T-distributed shock terms.
    *   `TraderAgent`: Represents a participant in the simulation with positions, margin, and equity.
    *   `RiskEngine`: Calculates Initial Margin (IM) based on Parametric Expected Shortfall (ES) derived from GARCH volatility.
    *   `SystemAggregator`: Computes the Systemic Stress Index (R_t) and determines the Circuit Breaker State (NORMAL, SOFT, HARD) and margin multipliers.
*   **`run_analysis.py`**: The main execution script. It orchestrates the Monte Carlo simulation, calculates key risk metrics (Probability of Default, VaR of Drawdown) for both models, and generates comparative plots.
*   **`data/`**: Directory containing historical market data (`ethusdt_1m2024-2025.csv`).
*   **`data_schema.txt`**: Describes the schema of the input data files.
*   **`ccp_risk_proposal.md`**: Provides theoretical background, formulas for risk metrics (like R_t), and the CCP's risk management framework.
*   **`simulation_plan.md`**: Outlines the Monte Carlo methodology, simulation parameters, and metrics for comparison.
*   **`pyproject.toml`**: Project dependency management file using `uv`.
*   **`uv.lock`**: Lock file generated by `uv` for reproducible environments.
*   **`garch_params.json`**: (Output) Stores the calibrated GARCH(1,1) parameters.
*   **`drawdown_distribution.png`**: (Output) Histogram comparing the Default Fund Drawdown distribution for both models.
*   **`pod_comparison.png`**: (Output) Bar chart comparing the Probability of Default (PoD) for both models.

## Key Features & Models

*   **Adaptive ES CCP Model**: Utilizes dynamic Initial Margin (IM) based on Parametric Expected Shortfall (ES) and adjusts margin multipliers according to the Systemic Stress Index (R_t) and Circuit Breaker states.
*   **Fixed-Leverage DEX (FXD) Model**: Represents a simpler model with static leverage (e.g., 20x) and a fixed Maintenance Margin.
*   **GARCH(1,1) Volatility**: Calibrated from historical data, providing a realistic volatility forecast for Monte Carlo simulations.
*   **T-distribution Shocks**: Used in Monte Carlo path generation to account for heavy tails in financial returns.
*   **Amihud Illiquidity Proxy**: Incorporated to model liquidity elasticity and its dynamic correlation with price shocks.
*   **Systemic Stress Index (R_t)**: A composite index combining various risk factors to trigger adaptive responses.
*   **Circuit Breaker Logic**: A state machine (NORMAL, SOFT, HARD) that dictates the system's response to increasing systemic stress.

## Setup Instructions

To set up the project environment and install dependencies, we use `uv`.

1.  **Ensure `uv` is installed**: If you don't have `uv` installed, you can install it using `pipx`:
    ```bash
    pipx install uv
    ```
    (You might need to install `pipx` first: `pip install pipx`)

2.  **Synchronize dependencies**: Navigate to the project root directory and run:
    ```bash
    uv sync
    ```
    This will create a virtual environment (`.venv`) and install all required packages listed in `pyproject.toml`.

## Running the Simulation

Follow these steps to execute the simulation and analysis:

1.  **Calibrate GARCH Model**:
    This step runs `calibrate.py` to process the historical data and save the GARCH parameters to `garch_params.json`.

    ```bash
    uv run python calibrate.py
    ```

2.  **Execute Monte Carlo Analysis**:
    This step runs `run_analysis.py`, which performs the 10,000 Monte Carlo simulations, calculates the required metrics, and generates comparative plots.

    ```bash
    uv run python run_analysis.py
    ```

## Expected Output

After successfully running the `run_analysis.py` script, you will see:

*   Console output summarizing the Probability of Default (PoD) and VaR of Drawdown for both AES and FXD models.
*   Two image files generated in the project root directory:
    *   `drawdown_distribution.png`: A histogram visualizing the distribution of default fund drawdowns.
    *   `pod_comparison.png`: A bar chart comparing the PoD for the Adaptive ES Model and the Fixed-Leverage DEX Model.
